/*! chrome-ang-app 01-11-2013 */
"use strict";var app=angular.module("noMoreLies",[]);app.controller("MainCtrl",function($scope,$timeout,Weather,UserService){$scope.date={};var updateTime=function(){$scope.date.tz=new Date((new Date).toLocaleString("en-US",{timezone:$scope.user.timezone})),$timeout(updateTime,1e3)};$scope.weather={},$scope.user=UserService.user,Weather.getWeatherForecast($scope.user.location).then(function(data){$scope.weather.forecast=data}),updateTime()}),app.controller("SettingsCtrl",function($scope,UserService,Weather){$scope.user=UserService.user,$scope.fetchCities=Weather.getCityDetails,$scope.save=function(){UserService.save()}}),app.factory("UserService",function(){var defaults={location:"autoip"},service={user:{},save:function(){sessionStorage.presently=angular.toJson(service.user)},restore:function(){return service.user=angular.fromJson(sessionStorage.presently)||defaults,service.user}};return service.restore(),service}),app.provider("Weather",function(){this.getUrl=function(type,ext){return"http://api.wunderground.com/api/"+this.apiKey+"/"+type+"/q/"+ext+".json"},this.setApiKey=function(key){key&&(this.apiKey=key)},this.$get=function($q,$http){var self=this;return{getWeatherForecast:function(city){var d=$q.defer();return $http({method:"GET",url:self.getUrl("forecast",city),cache:!0}).success(function(data){d.resolve(data.forecast.simpleforecast)}).error(function(err){d.reject(err)}),d.promise},getCityDetails:function(query){var d=$q.defer();return $http({method:"GET",url:"http://autocomplete.wunderground.com/aq?query="+query}).success(function(data){d.resolve(data.RESULTS)}).error(function(err){d.reject(err)}),d.promise}}}}),app.directive("autoFill",function($timeout){return{restrict:"EA",scope:{autoFill:"&",ngModel:"="},compile:function(tEle,tAttrs){var tplEl=angular.element('<div class="typehead"><input type="text" autocomplete="off" /><ul class="auto-list" ng-show="reslist"><li ng-repeat="res in reslist" >{{res.name}}</li></ul></div>'),input=tplEl.find("input");return input.attr("type",tAttrs.type),input.attr("ng-model",tAttrs.ngModel),input.attr("timezone",tAttrs.timezone),tEle.replaceWith(tplEl),function(scope,ele,attrs){var timer,val,minKeyCount=attrs.minKeyCount||3,input=ele.find("input");input.bind("keyup",function(){return val=ele.val(),val.length<minKeyCount?(timer&&$timeout.cancel(timer),scope.reslist=null,void 0):(timer&&$timeout.cancel(timer),timer=$timeout(function(){scope.autoFill()(val).then(function(data){data&&data.length>0&&(scope.reslist=data,scope.ngModel="zmw:"+data[0].zmw,scope.timezone=data[0].tz)})},300),void 0)}),input.bind("blur",function(){scope.reslist=null,scope.$digest()})}}}}),app.config(function(WeatherProvider){WeatherProvider.setApiKey("0bf91bb915508618")}),app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"templates/home.html",controller:"MainCtrl"}).when("/settings",{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}).otherwise({redirectTo:"/"})});
